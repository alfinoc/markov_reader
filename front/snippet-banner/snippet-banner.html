<link rel="import" href="../bower_components/paper-shadow/paper-shadow.html">
<link rel="import" href="../bower_components/paper-slider/paper-slider.html">
<link rel="import" href="../bower_components/paper-progress/paper-progress.html">
<link rel="import" href="../bower_components/core-ajax/core-ajax.html">
<link rel="import" href="../icons/icons.html">

<polymer-element name="snippet-banner">
   <template>
      <link rel="stylesheet" type="text/css" href="../control-banner/banner.css">
      <link rel="stylesheet" type="text/css" href="snippet-banner.css">
      <core-ajax id="ajax" url="../../source" params="{{ requestParams }}"
                 handleAs="json" on-core-response="{{ handleResponse }}"
                 on-core-error="{{ onError }}" loading="{{ loading }}"></core-ajax>
         <template if="{{ left && pivot && right }}">
            <div class="collapseable" hide?="{{ !positions || positions.length == 0 }}">
               <div id="wrapper" horizontal layout>
                  <template if="{{ positions.length > 1 }}">
                     <div id="leftbutton" on-click="{{ decrement }}" class="inheritColor">
                        <left-icon></left-icon>
                     </div>
                  </template>
                  <div class="left" flex><div>{{ left }}</div></div>
                  <span id="pivot">{{ pivot }}</span>
                  <div class="right" flex><div>{{ right }}</div></div>
                  <template if="{{ positions.length > 1 }}">
                     <div id="rightbutton" on-click="{{ increment }}" class="inheritColor">
                        <right-icon></right-icon>
                     </div>
                  </template>
               </div>
            </div>
         </template>
      <paper-progress indeterminate hide?="{{ !loading }}"></paper-progress>
      <paper-shadow z="1"></paper-shadow>
      <paper-toast id="ajaxerror" text="Uh oh, that's a server error."
                   class="dark"></paper-toast>
   </template>
   <script>

Polymer('snippet-banner', {
   publish: {
      source: {
         value: '',
         reflect: true
      },

      requestParams: '{}',
      loading: false,

      pivot: '',
      left: '',
      right: '',
   },

   observe: {
      positionIndex: 'loadSnippet',
      source: 'updateRequest',
      requestParams: 'updateRequest'
   },

   created: function() {
      this.positions = [];
      this.positionIndex = 0;
      this.snippetCache = {};
   },

   increment: function() {
      this.positionIndex++;
      this.capPositionIndex();
   },

   decrement: function() {
      this.positionIndex--;
      this.capPositionIndex();
   },

   loadSnippet: function() {
      // Cache hit.
      var entry = this.snippetCache[this.positionIndex];
      if (entry) {
         this.pivot = entry.pivot;
         this.left = entry.left;
         this.right = entry.right;

      // Cache miss -- fire the AJAX.
      } else {
         this.updateRequest();
      }
   },

   capPositionIndex: function() {
      this.positionIndex %= this.positions.length;
      if (this.positionIndex < 0)
         this.positionIndex += this.positions.length;
   },

   pivotChanged: function() {
      if (this.source && this.pivot) {
         var posQuery = document.querySelector('position-cache');
         if (posQuery) {
            posQuery.getPositions(this.source, this.pivot, function(positions) {
               this.positions = positions;
            }.bind(this));
         }
      }
   },

   positionsChanged: function() {
      this.positionIndex = 0;
      this.snippetCache = {};
      this.updateRequest();
   },

   handleResponse: function(e) {
      var center = e.detail.response.actual;
      var terms = e.detail.response.terms;
      this.pivot = terms[center];
      this.left = terms.slice(0, center).join(' ');
      this.right = terms.slice(center + 1).join(' ');

      // Log the newly acquired snippet in the cache.
      this.snippetCache[this.positionIndex] = {
         pivot: this.pivot, left: this.left, right: this.right
      }
   },

   validRequest: function() {
      if (!this.requestParams)
         return false;
      var req = JSON.parse(this.requestParams);
      return req.radius && req.key && req.position >= 0;
   },

   updateRequest: function() {
      this.requestParams = JSON.stringify({
         'key': this.source,
         'position': this.positions[this.positionIndex],
         'radius': 30,
      });
      if (this.validRequest())
         this.$.ajax.go();
   },

   onError: function(mesg) {
      this.$.ajaxerror.show();
      console.log(mesg);
   }
});
   </script>
</polymer-element>