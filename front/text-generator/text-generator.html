<link rel="import" href="../bower_components/core-ajax/core-ajax.html">

<polymer-element name="text-generator">
   <template>
      <core-ajax
         id="ajax"
         url="../../generate"
         params='{"sources":"dracula.txt", "length":"1000"}'
         handleAs="json"
         on-core-response="{{ handleNewBlock }}"></core-ajax>
   </template>
   <script>

Polymer('text-generator', {
   publish: {
      minBufferSize: 300,
      maxBufferSize: 1000,
      empty: true,
      loading: {
         value: false,
         reflect: true
      },

      lol: 0,

      seed: {
         value: '',
         reflect: true
      },
   },

   computed: {
      empty: 'buffer.length == 0'
   },

   created: function() {
      this.buffer = [];
      this.sources = [];
   },

   handleNewBlock: function(e) {
      var terms = e.detail.response.generated;
      this.seed = terms[terms.length - 1];
      this.buffer.push.apply(this.buffer, terms);
      this.loading = false;
      if (this.callback)
         this.callback();
   },

   next: function(callback) {
      var res = this.peek();
      if (res != undefined)
         this.buffer.shift();
      return res;
   },

   peek: function() {
      this.fillBuffer();
      if (this.empty)
         return undefined;
      return this.buffer[0];
   },

   fillBuffer: function() {
      console.log(this.loading + ', buffer size: ' + this.buffer.length);
      if (!this.loading && this.buffer.length < this.minBufferSize) {
         console.log('  firing ajax request');
         this.loading = true;
         this.$.ajax.go();
      }
   }
});

   </script>
</polymer-element>