<link rel="import" href="../bower_components/core-ajax/core-ajax.html">

<polymer-element name="text-generator">
   <template>
      <core-ajax
         id="ajax"
         url="../../generate"
         params="{{ requestParams }}"
         handleAs="json"
         on-core-response="{{ handleNewBlock }}"
         on-core-error="{{ onError }}"></core-ajax>
   </template>
   <script>

Polymer('text-generator', {
   publish: {
      minBufferSize: 300,
      maxBufferSize: 1000,
      loading: {
         value: false,
         reflect: true
      },
      seed: {
         value: '',
         reflect: true
      },
      sources: {
         value: [],
         reflect: true
      },
      requestParams: '{}'
   },

   observe: {
      sources: 'updateRequest',
      seed: 'updateRequest'
   },

   created: function() {
      this.buffer = [];
      this.sources = [];
      this.minBufferSize = 300;
   },

   handleNewBlock: function(e) {
      try {
         var terms = e.detail.response.generated;
         this.seed = terms[terms.length - 1];
         this.buffer.push.apply(this.buffer, terms);
         this.loading = false;
         if (this.callback)
            this.callback();
      } catch (err) {
         this.onError(err);
      }
   },

   next: function(callback) {
      var res = this.peek();
      if (res != undefined)
         this.buffer.shift();
      return res;
   },

   peek: function() {
      this.fillBuffer();
      if (this.buffer.length == 0)
         return undefined;
      return this.buffer[0];
   },

   fillBuffer: function() {
      console.log(this.loading + ', buffer size: ' + this.buffer.length);
      if (!this.loading && this.buffer.length < this.minBufferSize) {
         console.log('  firing ajax request');
         this.loading = true;
         this.$.ajax.go();
      }
   },

   updateRequest: function() {
      this.requestParams = JSON.stringify({
         'sources': this.sources,
         'seed': this.seed,
         'length': '1000'
      })
   },

   onError: function(err) {
      this.loading = false;
      console.log(err);
   }
});

   </script>
</polymer-element>