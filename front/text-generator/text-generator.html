<link rel="import" href="../bower_components/core-ajax/core-ajax.html">

<polymer-element name="text-generator">
   <template>
      <core-ajax
         id="ajax"
         url="../../generate"
         params='{"sources":"dracula.txt"}'
         handleAs="json"
         on-core-response="{{ handleNewBlock }}"
         loading="{{ loading }}"></core-ajax>
   </template>
   <script>

Polymer('text-generator', {
   publish: {
      minBufferSize: 100,
      maxBufferSize: 1000,
      empty: true,
      loading: {
         value: false,
         reflect: true
      },

      lol: 0,

      seed: {
         value: '',
         reflect: true
      },
   },

   computed: {
      empty: 'buffer.length == 0'
   },

   created: function() {
      this.buffer = [];
      this.sources = [];
   },

   domReady: function() {
      this.fillBuffer();
   },

   handleNewBlock: function(e) {
      var terms = e.detail.response.generated;
      this.seed = terms[terms.length - 1];
      this.buffer.push.apply(this.buffer, terms);
   },

   next: function() {
      var res = this.peek();
      if (res != undefined)
         this.buffer.shift();
      return res; 
   },

   peek: function() {
      this.fillBuffer();
      if (this.empty)
         return undefined;
      return this.buffer[0];
   },

   fillBuffer: function() {
      if (!this.loading && this.buffer.length < this.minBufferSize) {
         // TODO: ajax request here!
         var prev = this.lol;
         for (; this.lol < prev + 50; this.lol++)
            this.buffer.push('heh lol ' + this.lol);
         return;
         //this.$.ajax.go();
         return;
      } else if (!this.loading) {
         // TODO: you'll need to set this above with the ajax (or data-bind)
         return;
      }
   }
});

   </script>
</polymer-element>